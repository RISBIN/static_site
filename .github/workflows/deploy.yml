name: Blue-Green Deployment to Azure VM

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Blue-Green Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup SSH and Deploy (Blue-Green)
        run: |
          mkdir -p ~/.ssh

          # Try base64 decode first
          if echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '[:space:]' | base64 -d > ~/.ssh/id_ed25519 2>/dev/null && [ -s ~/.ssh/id_ed25519 ]; then
            echo "Using base64-encoded key"
          else
            echo "Base64 decode failed, using raw key"
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          fi

          chmod 600 ~/.ssh/id_ed25519

          if [ ! -s ~/.ssh/id_ed25519 ]; then
            echo "ERROR: SSH key file is empty"
            exit 1
          fi

          echo "SSH key configured successfully"

          # Add host to known hosts
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

          # Start Blue-Green deployment
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'ENDSSH'
            #!/bin/bash
            set -e

            echo "========================================"
            echo "üîµüü¢ Blue-Green Deployment Started"
            echo "Time: $(date)"
            echo "Triggered by: GitHub Actions"
            echo "========================================"

            CURRENT_LINK=$(readlink /var/www/current)

            if [[ $CURRENT_LINK == *"blue"* ]]; then
                ACTIVE_ENV="blue"
                INACTIVE_ENV="green"
                INACTIVE_DIR="/var/www/portfolio-green"
            else
                ACTIVE_ENV="green"
                INACTIVE_ENV="blue"
                INACTIVE_DIR="/var/www/portfolio-blue"
            fi

            echo "Active: $ACTIVE_ENV | Deploying to: $INACTIVE_ENV"
            echo ""

            echo "üì• Pulling latest code to $INACTIVE_ENV..."
            cd $INACTIVE_DIR
            git fetch origin main
            git reset --hard origin/main

            echo "üè• Creating temporary health check site..."
            sudo tee /etc/nginx/sites-available/test-$INACTIVE_ENV > /dev/null <<EOF
            server {
                listen 8888;
                root $INACTIVE_DIR;
                index index.html;
                location / { try_files \$uri \$uri/ =404; }
            }
            EOF

            sudo ln -sf /etc/nginx/sites-available/test-$INACTIVE_ENV /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx
            sleep 3

            echo "üè• Running health check..."
            if curl -f http://localhost:8888 > /dev/null 2>&1; then
                echo "‚úÖ Health check PASSED!"
                sudo rm /etc/nginx/sites-enabled/test-$INACTIVE_ENV
                sudo systemctl reload nginx

                echo "üîÄ Switching traffic to $INACTIVE_ENV..."
                sudo ln -sfn $INACTIVE_DIR /var/www/current
                sudo systemctl reload nginx

                echo "========================================"
                echo "üéâ Deployment Successful!"
                echo "New Active: $INACTIVE_ENV"
                echo "Time: $(date)"
                echo "========================================"
            else
                echo "‚ùå Health check FAILED!"
                sudo rm /etc/nginx/sites-enabled/test-$INACTIVE_ENV
                sudo systemctl reload nginx
                exit 1
            fi
          ENDSSH

      - name: Verify Deployment
        if: success()
        run: |
          echo "Waiting 5 seconds..."
          sleep 5

          echo "Checking website..."
          if curl -f http://${{ secrets.SSH_HOST }} > /dev/null 2>&1; then
            echo "‚úÖ Website is online!"
          else
            echo "‚ö†Ô∏è Warning: Website did not respond."
          fi

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/id_ed25519

      - name: Deployment Success
        if: success()
        run: |
          echo "üéâ Blue-Green Deployment Completed!"
          echo "Website: http://${{ secrets.SSH_HOST }}"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Previous version remains active."
